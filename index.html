<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Sistema de Registro de Ponto</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      background-color: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    .scanner-container {
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      padding: 30px;
      text-align: center;
      max-width: 500px;
      width: 100%;
    }

    #fingerprint-scanner {
      width: 250px;
      height: 250px;
      background-color: #f0f0f0;
      border-radius: 50%;
      margin: 20px auto;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #fingerprint-scanner.scanning {
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
      background-color: #e6f3e6;
    }

    #status-message {
      margin-top: 20px;
      font-weight: bold;
    }

    .modal-content {
      text-align: center;
    }

    .tab-content {
      padding: 20px 0;
    }
    
    /* Elementos ocultos necessários para o SDK Digital Persona */
    .hidden {
      display: none;
    }
    
    #imagediv {
      display: none;
    }
  </style>
</head>

<body>
  <div class="scanner-container">
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="registro-tab" data-bs-toggle="tab" data-bs-target="#registro" type="button"
          role="tab" aria-controls="registro" aria-selected="true">Registro de Ponto</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="cadastro-tab" data-bs-toggle="tab" data-bs-target="#cadastro" type="button"
          role="tab" aria-controls="cadastro" aria-selected="false">Cadastro</button>
      </li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <!-- Aba de Registro de Ponto -->
      <div class="tab-pane fade show active" id="registro" role="tabpanel" aria-labelledby="registro-tab">
        <h2>Registro de Ponto</h2>

        <div id="fingerprint-scanner">
          <i class="fas fa-fingerprint" style="font-size: 100px; color: #888;"></i>
        </div>

        <div id="status-message" class="text-muted">
          Coloque seu dedo no scanner para registrar o ponto
        </div>

        <div id="clock" class="mt-3 h4"></div>
      </div>

      <!-- Aba de Cadastro -->
      <div class="tab-pane fade" id="cadastro" role="tabpanel" aria-labelledby="cadastro-tab">
        <h2>Cadastro de Funcionário</h2>

        <form id="cadastroForm" class="mt-3">
          <div class="mb-3">
            <label for="nome" class="form-label">Nome Completo</label>
            <input type="text" class="form-control" id="nome" required>
          </div>
          <div class="mb-3">
            <label for="cargo" class="form-label">Cargo</label>
            <input type="text" class="form-control" id="cargo" required>
          </div>
          <div class="mb-3">
            <label for="departamento" class="form-label">Departamento</label>
            <input type="text" class="form-control" id="departamento" required>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">E-mail</label>
            <input type="email" class="form-control" id="email" required>
          </div>
          <button type="submit" class="btn btn-primary">Cadastrar Digital</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmação -->
  <div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Registro de Ponto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- Conteúdo dinâmico -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Elementos ocultos necessários para o SDK Digital Persona -->
  <div class="hidden">
    <div id="content-capture">
      <div id="status"></div>
    </div>
    <div id="content-reader" style="display:none;"></div>
    <div id="imagediv"></div>
    <div id="Scores" style="display:none;">
      <input type="text" id="qualityInputBox" />
    </div>
    <form name="myForm">
      <input type="radio" name="PngImage" checked="checked" />
    </form>
    <select id="readersDropDown"></select>
    <div id="deviceInfo"></div>
    <div id="imageGallery"></div>
  </div>

  <!-- Dependências -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <!-- Scripts do SDK Digital Persona -->
  <script src="scripts/fingerprint.sdk.min.js"></script>
  <script src="app.js"></script>
  
  <!-- Scripts do nosso sistema -->
  <script src="scripts/backend/fingerprint-service.js"></script>
  <script src="scripts/backend/firebase-service.js"></script>
  <script src="scripts/backend/fingerprint-controller.js"></script>

  <script>
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBTr3UtLKbxdgcpdkpnttyRMrQ6tDDsZIc",
      authDomain: "allenbreak.firebaseapp.com",
      projectId: "allenbreak",
      storageBucket: "allenbreak.firebasestorage.app",
      messagingSenderId: "1075308477600",
      appId: "1:1075308477600:web:7efd6a39446646a7f11dc5",
      measurementId: "G-CYB4F5GB76"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);

    // Inicializar o sistema quando o DOM estiver carregado
    document.addEventListener('DOMContentLoaded', () => {
      const controller = new FingerprintController();

      // Inicializa o relógio
      const clockElement = document.getElementById('clock');
      setInterval(() => {
        const now = new Date();
        clockElement.textContent = now.toLocaleString('pt-BR', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      }, 1000);

      // Configura o evento de clique no scanner para registro de ponto
      const scanner = document.getElementById('fingerprint-scanner');
      scanner.addEventListener('click', async () => {
        const resultado = await controller.autenticarFuncionario();

        // Exibe o modal com o resultado
        const modal = new bootstrap.Modal(document.getElementById('resultModal'));
        const modalBody = document.getElementById('modalBody');

        if (resultado.success) {
          const funcionario = resultado.funcionario;
          const registro = resultado.registro;

          modalBody.innerHTML = `
                    <div class="alert alert-success">
                        <h4>Registro Confirmado!</h4>
                        <p>Olá, ${funcionario.nome}</p>
                        <p>Tipo: ${registro.tipo}</p>
                        <p>Horário: ${registro.horario.toLocaleTimeString('pt-BR')}</p>
                    </div>
                `;
        } else {
          modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Erro no Registro</h4>
                        <p>${resultado.error || resultado.mensagem || 'Digital não reconhecida'}</p>
                        <p>Por favor, tente novamente</p>
                    </div>
                `;
        }

        modal.show();
      });

      // Configura o formulário de cadastro
      const cadastroForm = document.getElementById('cadastroForm');
      cadastroForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const dadosFuncionario = {
          nome: document.getElementById('nome').value,
          cargo: document.getElementById('cargo').value,
          departamento: document.getElementById('departamento').value,
          email: document.getElementById('email').value
        };

        const resultado = await controller.cadastrarFuncionario(dadosFuncionario);

        // Exibe o modal com o resultado
        const modal = new bootstrap.Modal(document.getElementById('resultModal'));
        const modalBody = document.getElementById('modalBody');

        if (resultado && resultado.success) {
          modalBody.innerHTML = `
                    <div class="alert alert-success">
                        <h4>Cadastro Realizado!</h4>
                        <p>${resultado.mensagem}</p>
                        <p>Funcionário: ${dadosFuncionario.nome}</p>
                        <p>ID: ${resultado.funcionarioId}</p>
                    </div>
                `;

          // Limpa o formulário
          cadastroForm.reset();
        } else {
          modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Erro no Cadastro</h4>
                        <p>${resultado ? resultado.error : 'Ocorreu um erro durante o cadastro'}</p>
                        <p>Por favor, tente novamente</p>
                    </div>
                `;
        }

        modal.show();
      });
    });
  </script>
</body>

</html>